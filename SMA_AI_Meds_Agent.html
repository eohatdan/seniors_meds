import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

// Replace with your actual values
const supabaseUrl = "https://db.ixxzxenspwzrkiazepbj.supabase.co";
const supabaseKey = "D7FlItsKhOWsFr6sm";
const supabase = createClient(supabaseUrl, supabaseKey);

const openaiApiKey = "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"; // Consider loading from env or secure config

const openaiApi = async (messages) => {
  const res = await fetch("https://api.openai.com/v1/chat/completions", {
    method: "POST",
    headers: {
      "Authorization": `Bearer ${openaiApiKey}`,
      "Content-Type": "application/json"
    },
    body: JSON.stringify({
      model: "gpt-4-turbo",
      messages: messages,
      temperature: 0.7
    })
  });
  const data = await res.json();
  return data.choices[0].message.content;
};

// Step 1: Retrieve patient data from Supabase
async function getPatientData(patientId) {
  const { data, error } = await supabase
    .from("patients")
    .select("*")
    .eq("id", patientId)
    .single();

  if (error) throw new Error("Patient not found");
  return data;
}

// Step 2: Ask GPT to generate a better prompt
async function generateContextPrompt(userQuestion, patientData) {
  const messages = [
    {
      role: "system",
      content: "You are a medical AI assistant that rewrites vague user questions into specific prompts based on patient data."
    },
    {
      role: "user",
      content: `The user asked: "${userQuestion}"\n\nHere is the patient data:\n${JSON.stringify(patientData, null, 2)}\n\nRewrite the user's question as a medically informed prompt including all relevant patient information.`
    }
  ];
  return await openaiApi(messages);
}

// Step 3: Ask GPT the refined question
async function getMedicalResponse(refinedPrompt) {
  const messages = [
    {
      role: "system",
      content: "You are a clinical assistant providing safe, informed responses for patient care."
    },
    {
      role: "user",
      content: refinedPrompt
    }
  ];
  return await openaiApi(messages);
}

// High-level function for self-prompting logic
export async function askMedicalQuestion(patientId, userQuestion) {
  try {
    const patientData = await getPatientData(patientId);
    const refinedPrompt = await generateContextPrompt(userQuestion, patientData);
    const finalResponse = await getMedicalResponse(refinedPrompt);

    return {
      prompt: refinedPrompt,
      answer: finalResponse
    };
  } catch (err) {
    return { error: err.message };
  }
}
